machine:
  timezone:
    Asia/Tokyo
checkout:
  post:
    - git submodule sync
    - git submodule update --init
dependencies:
  pre:
    - curl -o $HOME/go_appengine_1.9.12.zip https://storage.googleapis.com/appengine-sdks/featured/go_appengine_sdk_linux_amd64-1.9.12.zip
    - unzip -q -d $HOME $HOME/go_appengine_1.9.12.zip
  override:
    - $HOME/go_appengine/goapp build
test:
  override:
    - go get -v code.google.com/p/go.tools/cmd/cover
    - go get -v github.com/mattn/goveralls
    - $HOME/go_appengine/goapp test -v -covermode=count -coverprofile=coverage.out
    - goveralls -coverprofile=coverage.out -service=circle-ci -repotoken $COVERALLS_TOKEN
deployment:
  appengine:
    branch: master
    commands:
      -  $HOME/go_appengine/appcfg.py --oauth2_refresh_token=$APPENGINE_TOKEN update .
